"use strict";(()=>{var e={};e.id=561,e.ids=[561],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2048:e=>{e.exports=require("fs")},3263:e=>{e.exports=import("firebase-admin/app")},2929:e=>{e.exports=import("firebase-admin/firestore")},1093:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>u,requestAsyncStorage:()=>d,routeModule:()=>l,serverHooks:()=>I,staticGenerationAsyncStorage:()=>p});var s=r(9303),i=r(8716),o=r(670),a=r(605),c=e([a]);a=(c.then?(await c)():c)[0];let l=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/signatures/[docId]/route",pathname:"/api/signatures/[docId]",filename:"route",bundlePath:"app/api/signatures/[docId]/route"},resolvedPagePath:"/Users/talyaron/Documents/Freedi-app/apps/sign/app/api/signatures/[docId]/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:I}=l,g="/api/signatures/[docId]/route";function u(){return(0,o.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:p})}n()}catch(e){n(e)}})},605:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{GET:()=>u,POST:()=>l});var s=r(7070),i=r(6128),o=r(5734),a=r(5697),c=e([i]);async function u(e,{params:t}){try{let{docId:r}=await t,n=(0,o.ld)(e.headers.get("cookie"));if(!n)return s.NextResponse.json({error:"User not authenticated"},{status:401});let c=(0,i.Rx)(),u=`${n}--${r}`,l=await c.collection(a.nW.signatures).doc(u).get();if(!l.exists)return s.NextResponse.json({signature:null});return s.NextResponse.json({signature:l.data()})}catch(e){return console.error("[Signatures API] GET error:",e),s.NextResponse.json({error:"Internal server error"},{status:500})}}async function l(e,{params:t}){try{let{docId:r}=await t,n=(0,o.ld)(e.headers.get("cookie"));if(!n)return s.NextResponse.json({error:"User not authenticated"},{status:401});let{signed:c,levelOfSignature:u}=await e.json();if(!["signed","rejected","viewed"].includes(c))return s.NextResponse.json({error:"Invalid signature status"},{status:400});let l=(0,i.Rx)(),d=`${n}--${r}`,p=await l.collection(a.nW.signatures).doc(d).get(),I=p.exists?p.data():null;if("viewed"===c&&I&&("signed"===I.signed||"rejected"===I.signed))return s.NextResponse.json({signature:I});let g=await l.collection(a.nW.statements).doc(r).get(),E=g.exists?g.data():null,R={signatureId:d,documentId:r,topParentId:E?.topParentId||r,parentId:E?.parentId||r,userId:n,signed:c,date:Date.now(),levelOfSignature:u??0};return await l.collection(a.nW.signatures).doc(d).set(R,{merge:!0}),console.info(`[Signatures API] Created/updated signature: ${d} - ${c}`),s.NextResponse.json({success:!0,signature:R})}catch(e){return console.error("[Signatures API] POST error:",e),s.NextResponse.json({error:"Internal server error"},{status:500})}}i=(c.then?(await c)():c)[0],n()}catch(e){n(e)}})},5697:(e,t,r)=>{r.d(t,{nW:()=>n.nW});var n=r(3704)},6128:(e,t,r)=>{r.a(e,async(e,n)=>{try{let l,d;r.d(t,{IW:()=>u,Rx:()=>c});var s=r(3263),i=r(2929),o=e([s,i]);function a(){if((0,s.getApps)().length>0)return l=(0,s.getApps)()[0];try{let e=process.env.FIREBASE_CLIENT_EMAIL&&process.env.FIREBASE_PRIVATE_KEY,t=process.env.GOOGLE_APPLICATION_CREDENTIALS;if(e)l=(0,s.initializeApp)({credential:(0,s.cert)({projectId:process.env.FIREBASE_PROJECT_ID,clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g,"\n")}),projectId:process.env.FIREBASE_PROJECT_ID}),console.info("[Firebase Admin - Sign] Initialized with explicit credentials");else if(t){let e=r(2048),n=JSON.parse(e.readFileSync(t,"utf8"));l=(0,s.initializeApp)({credential:(0,s.cert)(n),projectId:n.project_id}),console.info("[Firebase Admin - Sign] Initialized with service account file")}else l=(0,s.initializeApp)({projectId:process.env.FIREBASE_PROJECT_ID}),console.info("[Firebase Admin - Sign] Initialized with default credentials");return l}catch(e){throw console.error("[Firebase Admin - Sign] Initialization failed:",e),e}}function c(){if(!d){l||a(),d=(0,i.getFirestore)(l);let e=process.env.FIRESTORE_EMULATOR_HOST;e?console.info("[Firebase Admin - Sign] Connected to Firestore emulator:",e):console.info("[Firebase Admin - Sign] Connected to production Firestore")}return d}function u(){return l||a(),{db:c(),app:l}}[s,i]=o.then?(await o)():o,"true"===process.env.USE_FIREBASE_EMULATOR&&process.env.FIRESTORE_EMULATOR_HOST&&(process.env.FIRESTORE_EMULATOR_HOST=process.env.FIRESTORE_EMULATOR_HOST),n()}catch(e){n(e)}})},5734:(e,t,r)=>{function n(e){if(!e)return null;let t=e.match(/userId=([^;]+)/);return t?t[1]:null}function s(e){if(!e)return null;let t=e.match(/userDisplayName=([^;]+)/);return t?decodeURIComponent(t[1]):null}function i(e){let t=e.match(/anon_(\d+)_/);if(t){let e=parseInt(t[1]);return`User ${e.toString().slice(-6)}`}return"Anonymous User"}function o(e){let t=function(e){let t=e.get("userId");return t?.value??null}(e);if(!t)return null;let r=e.get("userDisplayName"),n=r?.value?decodeURIComponent(r.value):i(t);return{uid:t,displayName:n,isAnonymous:t.startsWith("anon_")}}r.d(t,{BD:()=>s,CV:()=>i,N5:()=>o,ld:()=>n})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[380,704,972],()=>r(1093));module.exports=n})();