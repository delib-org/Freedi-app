"use strict";(()=>{var e={};e.id=510,e.ids=[510],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2048:e=>{e.exports=require("fs")},3263:e=>{e.exports=import("firebase-admin/app")},2929:e=>{e.exports=import("firebase-admin/firestore")},8446:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{originalPathname:()=>I,patchFetch:()=>c,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>u});var a=n(9303),i=n(8716),o=n(670),s=n(2295),l=e([s]);s=(l.then?(await l)():l)[0];let d=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/stats/[docId]/route",pathname:"/api/admin/stats/[docId]",filename:"route",bundlePath:"app/api/admin/stats/[docId]/route"},resolvedPagePath:"/Users/talyaron/Documents/Freedi-app/apps/sign/app/api/admin/stats/[docId]/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:u,serverHooks:m}=d,I="/api/admin/stats/[docId]/route";function c(){return(0,o.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:u})}r()}catch(e){r(e)}})},2295:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{GET:()=>c});var a=n(7070),i=n(6128),o=n(5734),s=n(5697),l=e([i]);async function c(e,{params:t}){try{let{docId:n}=await t,r=(0,o.ld)(e.headers.get("cookie"));if(!r)return a.NextResponse.json({error:"Unauthorized"},{status:401});let{db:l}=(0,i.IW)(),c=l.collection(s.nW.statements).doc(n),d=await c.get();if(!d.exists)return a.NextResponse.json({error:"Document not found"},{status:404});let p=d.data();if(!(p?.creator?.odlUserId===r||p?.creatorId===r))return a.NextResponse.json({error:"Forbidden - Admin access required"},{status:403});let u=(await l.collection(s.nW.signatures).where("documentId","==",n).get()).docs.map(e=>e.data()),m=u.filter(e=>"signed"===e.signed).length,I=u.filter(e=>"rejected"===e.signed).length,g=u.filter(e=>"viewed"===e.signed).length,h=u.length,f=await l.collection(s.nW.statements).where("parentId","==",n).get(),E=f.docs.map(e=>e.id),v=0;if(E.length>0)for(let e=0;e<E.length;e+=10){let t=E.slice(e,e+10),n=await l.collection(s.nW.statements).where("parentId","in",t).where("statementType","==","comment").get();v+=n.size}let A=(await l.collection(s.nW.evaluations).where("parentId","==",n).get()).docs.map(e=>e.data()),R=A.length,_=R>0?A.reduce((e,t)=>e+(t.evaluation||0),0)/R:0,S=[];for(let e of f.docs){let t=e.data(),n=e.id,r=A.filter(e=>e.statementId===n),a=r.length>0?r.reduce((e,t)=>e+(t.evaluation||0),0)/r.length:0,i=await l.collection(s.nW.statements).where("parentId","==",n).where("statementType","==","comment").get();S.push({paragraphId:n,statement:t.statement?.substring(0,100)||"",viewCount:t.viewed||0,approvalCount:r.length,avgApproval:Math.round(100*a)/100,commentCount:i.size})}S.sort((e,t)=>t.approvalCount-e.approvalCount);let w={totalParticipants:h,signedCount:m,rejectedCount:I,viewedCount:g,pendingCount:Math.max(0,h-m-I),totalComments:v,totalApprovals:R,averageApprovalRating:Math.round(100*_)/100,paragraphStats:S.slice(0,10)};return a.NextResponse.json(w)}catch(e){return console.error("[API] Admin stats failed:",e),a.NextResponse.json({error:"Internal server error"},{status:500})}}i=(l.then?(await l)():l)[0],r()}catch(e){r(e)}})},5697:(e,t,n)=>{n.d(t,{nW:()=>r.nW});var r=n(3704)},6128:(e,t,n)=>{n.a(e,async(e,r)=>{try{let d,p;n.d(t,{IW:()=>c,Rx:()=>l});var a=n(3263),i=n(2929),o=e([a,i]);function s(){if((0,a.getApps)().length>0)return d=(0,a.getApps)()[0];try{let e=process.env.FIREBASE_CLIENT_EMAIL&&process.env.FIREBASE_PRIVATE_KEY,t=process.env.GOOGLE_APPLICATION_CREDENTIALS;if(e)d=(0,a.initializeApp)({credential:(0,a.cert)({projectId:process.env.FIREBASE_PROJECT_ID,clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g,"\n")}),projectId:process.env.FIREBASE_PROJECT_ID}),console.info("[Firebase Admin - Sign] Initialized with explicit credentials");else if(t){let e=n(2048),r=JSON.parse(e.readFileSync(t,"utf8"));d=(0,a.initializeApp)({credential:(0,a.cert)(r),projectId:r.project_id}),console.info("[Firebase Admin - Sign] Initialized with service account file")}else d=(0,a.initializeApp)({projectId:process.env.FIREBASE_PROJECT_ID}),console.info("[Firebase Admin - Sign] Initialized with default credentials");return d}catch(e){throw console.error("[Firebase Admin - Sign] Initialization failed:",e),e}}function l(){if(!p){d||s(),p=(0,i.getFirestore)(d);let e=process.env.FIRESTORE_EMULATOR_HOST;e?console.info("[Firebase Admin - Sign] Connected to Firestore emulator:",e):console.info("[Firebase Admin - Sign] Connected to production Firestore")}return p}function c(){return d||s(),{db:l(),app:d}}[a,i]=o.then?(await o)():o,"true"===process.env.USE_FIREBASE_EMULATOR&&process.env.FIRESTORE_EMULATOR_HOST&&(process.env.FIRESTORE_EMULATOR_HOST=process.env.FIRESTORE_EMULATOR_HOST),r()}catch(e){r(e)}})},5734:(e,t,n)=>{function r(e){if(!e)return null;let t=e.match(/userId=([^;]+)/);return t?t[1]:null}function a(e){if(!e)return null;let t=e.match(/userDisplayName=([^;]+)/);return t?decodeURIComponent(t[1]):null}function i(e){let t=e.match(/anon_(\d+)_/);if(t){let e=parseInt(t[1]);return`User ${e.toString().slice(-6)}`}return"Anonymous User"}function o(e){let t=function(e){let t=e.get("userId");return t?.value??null}(e);if(!t)return null;let n=e.get("userDisplayName"),r=n?.value?decodeURIComponent(n.value):i(t);return{uid:t,displayName:r,isAnonymous:t.startsWith("anon_")}}n.d(t,{BD:()=>a,CV:()=>i,N5:()=>o,ld:()=>r})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[380,704,972],()=>n(8446));module.exports=r})();