"use strict";(()=>{var e={};e.id=399,e.ids=[399],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2048:e=>{e.exports=require("fs")},3263:e=>{e.exports=import("firebase-admin/app")},2929:e=>{e.exports=import("firebase-admin/firestore")},4621:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>l,requestAsyncStorage:()=>u,routeModule:()=>c,serverHooks:()=>I,staticGenerationAsyncStorage:()=>p});var s=r(9303),o=r(8716),i=r(670),a=r(3715),d=e([a]);a=(d.then?(await d)():d)[0];let c=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/users/[docId]/route",pathname:"/api/admin/users/[docId]",filename:"route",bundlePath:"app/api/admin/users/[docId]/route"},resolvedPagePath:"/Users/talyaron/Documents/Freedi-app/apps/sign/app/api/admin/users/[docId]/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:u,staticGenerationAsyncStorage:p,serverHooks:I}=c,m="/api/admin/users/[docId]/route";function l(){return(0,i.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:p})}n()}catch(e){n(e)}})},3715:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{GET:()=>l});var s=r(7070),o=r(6128),i=r(5734),a=r(5697),d=e([o]);async function l(e,{params:t}){try{let{docId:r}=await t,n=(0,i.ld)(e.headers.get("cookie"));if(!n)return s.NextResponse.json({error:"Unauthorized"},{status:401});let{db:d}=(0,o.IW)(),l=d.collection(a.nW.statements).doc(r),c=await l.get();if(!c.exists)return s.NextResponse.json({error:"Document not found"},{status:404});let u=c.data();if(!(u?.creator?.odlUserId===n||u?.creatorId===n))return s.NextResponse.json({error:"Forbidden - Admin access required"},{status:403});let{searchParams:p}=new URL(e.url),I=p.get("status"),m=p.get("search")?.toLowerCase(),E=d.collection(a.nW.signatures).where("documentId","==",r);I&&"all"!==I&&(E=E.where("signed","==",I));let A=await E.get(),f=await d.collection(a.nW.approval).where("documentId","==",r).get(),g=new Map;f.docs.forEach(e=>{let t=e.data(),r=g.get(t.odlUserId)||0;g.set(t.odlUserId,r+1)});let R=await d.collection(a.nW.statements).where("topParentId","==",r).where("statementType","==","statement").get(),h=new Map;R.docs.forEach(e=>{let t=e.data();if(t.creatorId){let e=h.get(t.creatorId)||0;h.set(t.creatorId,e+1)}});let v=A.docs.map(e=>{let t=e.data();return{odlUserId:t.odlUserId||t.userId,odlUserDisplayName:t.odlUserDisplayName||t.displayName||"Anonymous",signed:t.signed||"pending",signedAt:t.date||null,approvalsCount:g.get(t.odlUserId||t.userId)||0,commentsCount:h.get(t.odlUserId||t.userId)||0}}),_=v;return m&&(_=v.filter(e=>e.odlUserDisplayName.toLowerCase().includes(m)||e.odlUserId.toLowerCase().includes(m))),_.sort((e,t)=>(t.signedAt||0)-(e.signedAt||0)),s.NextResponse.json({users:_,total:_.length})}catch(e){return console.error("[API] Admin users failed:",e),s.NextResponse.json({error:"Internal server error"},{status:500})}}o=(d.then?(await d)():d)[0],n()}catch(e){n(e)}})},5697:(e,t,r)=>{r.d(t,{nW:()=>n.nW});var n=r(3704)},6128:(e,t,r)=>{r.a(e,async(e,n)=>{try{let c,u;r.d(t,{IW:()=>l,Rx:()=>d});var s=r(3263),o=r(2929),i=e([s,o]);function a(){if((0,s.getApps)().length>0)return c=(0,s.getApps)()[0];try{let e=process.env.FIREBASE_CLIENT_EMAIL&&process.env.FIREBASE_PRIVATE_KEY,t=process.env.GOOGLE_APPLICATION_CREDENTIALS;if(e)c=(0,s.initializeApp)({credential:(0,s.cert)({projectId:process.env.FIREBASE_PROJECT_ID,clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g,"\n")}),projectId:process.env.FIREBASE_PROJECT_ID}),console.info("[Firebase Admin - Sign] Initialized with explicit credentials");else if(t){let e=r(2048),n=JSON.parse(e.readFileSync(t,"utf8"));c=(0,s.initializeApp)({credential:(0,s.cert)(n),projectId:n.project_id}),console.info("[Firebase Admin - Sign] Initialized with service account file")}else c=(0,s.initializeApp)({projectId:process.env.FIREBASE_PROJECT_ID}),console.info("[Firebase Admin - Sign] Initialized with default credentials");return c}catch(e){throw console.error("[Firebase Admin - Sign] Initialization failed:",e),e}}function d(){if(!u){c||a(),u=(0,o.getFirestore)(c);let e=process.env.FIRESTORE_EMULATOR_HOST;e?console.info("[Firebase Admin - Sign] Connected to Firestore emulator:",e):console.info("[Firebase Admin - Sign] Connected to production Firestore")}return u}function l(){return c||a(),{db:d(),app:c}}[s,o]=i.then?(await i)():i,"true"===process.env.USE_FIREBASE_EMULATOR&&process.env.FIRESTORE_EMULATOR_HOST&&(process.env.FIRESTORE_EMULATOR_HOST=process.env.FIRESTORE_EMULATOR_HOST),n()}catch(e){n(e)}})},5734:(e,t,r)=>{function n(e){if(!e)return null;let t=e.match(/userId=([^;]+)/);return t?t[1]:null}function s(e){if(!e)return null;let t=e.match(/userDisplayName=([^;]+)/);return t?decodeURIComponent(t[1]):null}function o(e){let t=e.match(/anon_(\d+)_/);if(t){let e=parseInt(t[1]);return`User ${e.toString().slice(-6)}`}return"Anonymous User"}function i(e){let t=function(e){let t=e.get("userId");return t?.value??null}(e);if(!t)return null;let r=e.get("userDisplayName"),n=r?.value?decodeURIComponent(r.value):o(t);return{uid:t,displayName:n,isAnonymous:t.startsWith("anon_")}}r.d(t,{BD:()=>s,CV:()=>o,N5:()=>i,ld:()=>n})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[380,704,972],()=>r(4621));module.exports=n})();