"use strict";(()=>{var e={};e.id=778,e.ids=[778],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2048:e=>{e.exports=require("fs")},3263:e=>{e.exports=import("firebase-admin/app")},2929:e=>{e.exports=import("firebase-admin/firestore")},9039:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{originalPathname:()=>m,patchFetch:()=>d,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>I,staticGenerationAsyncStorage:()=>u});var o=n(9303),i=n(8716),a=n(670),s=n(9781),c=e([s]);s=(c.then?(await c)():c)[0];let l=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/export/[docId]/route",pathname:"/api/admin/export/[docId]",filename:"route",bundlePath:"app/api/admin/export/[docId]/route"},resolvedPagePath:"/Users/talyaron/Documents/Freedi-app/apps/sign/app/api/admin/export/[docId]/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:u,serverHooks:I}=l,m="/api/admin/export/[docId]/route";function d(){return(0,a.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:u})}r()}catch(e){r(e)}})},9781:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{GET:()=>d});var o=n(7070),i=n(6128),a=n(5734),s=n(5697),c=e([i]);async function d(e,{params:t}){try{let{docId:n}=await t,r=(0,a.ld)(e.headers.get("cookie"));if(!r)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{db:c}=(0,i.IW)(),d=c.collection(s.nW.statements).doc(n),l=await d.get();if(!l.exists)return o.NextResponse.json({error:"Document not found"},{status:404});let p=l.data();if(!(p?.creator?.odlUserId===r||p?.creatorId===r))return o.NextResponse.json({error:"Forbidden - Admin access required"},{status:403});let u=await c.collection(s.nW.signatures).where("documentId","==",n).get(),I=await c.collection(s.nW.approval).where("documentId","==",n).get(),m=new Map;I.docs.forEach(e=>{let t=e.data(),n=t.odlUserId||t.userId,r=m.get(n)||0;m.set(n,r+1)});let E=await c.collection(s.nW.statements).where("topParentId","==",n).where("statementType","==","statement").get(),f=new Map;E.docs.forEach(e=>{let t=e.data();if(t.creatorId){let e=f.get(t.creatorId)||0;f.set(t.creatorId,e+1)}});let A=[];u.docs.forEach(e=>{let t=e.data(),n=t.odlUserId||t.userId;A.push([n,t.odlUserDisplayName||t.displayName||"Anonymous",t.signed||"pending",t.date?new Date(t.date).toISOString():"",String(m.get(n)||0),String(f.get(n)||0)])}),A.sort((e,t)=>{let n=e[3]?new Date(e[3]).getTime():0;return(t[3]?new Date(t[3]).getTime():0)-n});let g=e=>e.includes(",")||e.includes('"')||e.includes("\n")?`"${e.replace(/"/g,'""')}"`:e,R=["User ID,Display Name,Status,Date,Approvals Count,Comments Count",...A.map(e=>e.map(g).join(","))].join("\n");return new o.NextResponse(R,{status:200,headers:{"Content-Type":"text/csv","Content-Disposition":`attachment; filename="document-users-${n}.csv"`}})}catch(e){return console.error("[API] Admin export failed:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}i=(c.then?(await c)():c)[0],r()}catch(e){r(e)}})},5697:(e,t,n)=>{n.d(t,{nW:()=>r.nW});var r=n(3704)},6128:(e,t,n)=>{n.a(e,async(e,r)=>{try{let l,p;n.d(t,{IW:()=>d,Rx:()=>c});var o=n(3263),i=n(2929),a=e([o,i]);function s(){if((0,o.getApps)().length>0)return l=(0,o.getApps)()[0];try{let e=process.env.FIREBASE_CLIENT_EMAIL&&process.env.FIREBASE_PRIVATE_KEY,t=process.env.GOOGLE_APPLICATION_CREDENTIALS;if(e)l=(0,o.initializeApp)({credential:(0,o.cert)({projectId:process.env.FIREBASE_PROJECT_ID,clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g,"\n")}),projectId:process.env.FIREBASE_PROJECT_ID}),console.info("[Firebase Admin - Sign] Initialized with explicit credentials");else if(t){let e=n(2048),r=JSON.parse(e.readFileSync(t,"utf8"));l=(0,o.initializeApp)({credential:(0,o.cert)(r),projectId:r.project_id}),console.info("[Firebase Admin - Sign] Initialized with service account file")}else l=(0,o.initializeApp)({projectId:process.env.FIREBASE_PROJECT_ID}),console.info("[Firebase Admin - Sign] Initialized with default credentials");return l}catch(e){throw console.error("[Firebase Admin - Sign] Initialization failed:",e),e}}function c(){if(!p){l||s(),p=(0,i.getFirestore)(l);let e=process.env.FIRESTORE_EMULATOR_HOST;e?console.info("[Firebase Admin - Sign] Connected to Firestore emulator:",e):console.info("[Firebase Admin - Sign] Connected to production Firestore")}return p}function d(){return l||s(),{db:c(),app:l}}[o,i]=a.then?(await a)():a,"true"===process.env.USE_FIREBASE_EMULATOR&&process.env.FIRESTORE_EMULATOR_HOST&&(process.env.FIRESTORE_EMULATOR_HOST=process.env.FIRESTORE_EMULATOR_HOST),r()}catch(e){r(e)}})},5734:(e,t,n)=>{function r(e){if(!e)return null;let t=e.match(/userId=([^;]+)/);return t?t[1]:null}function o(e){if(!e)return null;let t=e.match(/userDisplayName=([^;]+)/);return t?decodeURIComponent(t[1]):null}function i(e){let t=e.match(/anon_(\d+)_/);if(t){let e=parseInt(t[1]);return`User ${e.toString().slice(-6)}`}return"Anonymous User"}function a(e){let t=function(e){let t=e.get("userId");return t?.value??null}(e);if(!t)return null;let n=e.get("userDisplayName"),r=n?.value?decodeURIComponent(n.value):i(t);return{uid:t,displayName:r,isAnonymous:t.startsWith("anon_")}}n.d(t,{BD:()=>o,CV:()=>i,N5:()=>a,ld:()=>r})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[380,704,972],()=>n(9039));module.exports=r})();