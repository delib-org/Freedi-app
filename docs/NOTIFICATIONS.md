# Notifications Documentation

## Overview

The Freedi app uses Firebase Cloud Messaging (FCM) for push notifications. This document covers the notification system architecture, key components, and debugging utilities.

## Centralized Notification Management

As of the latest update, the notification system supports centralized management of notifications across all user devices. This allows users to control their notification preferences from a single point, affecting all their registered devices.

### Key Features:

1. **Multi-Device Token Storage**
   - All device FCM tokens are stored in the `tokens` array within `statementsSubscribe` collection
   - Tokens are automatically synced when users log in from new devices
   - Old/invalid tokens are automatically cleaned up

2. **Granular Notification Control**
   - `getInAppNotification`: Controls in-app notifications
   - `getPushNotification`: Controls push notifications across all devices
   - `getEmailNotification`: Controls email notifications

3. **Token Management Functions**
   ```typescript
   // Add token to subscription
   addTokenToSubscription(statementId, userId, token)
   
   // Remove token from subscription
   removeTokenFromSubscription(statementId, userId, token)
   
   // Update notification preferences
   updateNotificationPreferences(statementId, userId, {
     getPushNotification: true,
     getInAppNotification: true,
     getEmailNotification: false
   })
   ```

4. **Automatic Token Synchronization**
   - On login: Current device token is added to all user's subscriptions
   - On logout: Token is removed from all subscriptions
   - On token refresh: Old token replaced with new token

## Architecture

### Core Components

#### 1. **NotificationService** (`/src/services/notificationService.ts`)
The main service that handles all notification-related operations. Implemented as a singleton pattern.

**Key Methods:**
- `initialize(userId: string)` - Initialize notifications for a user
- `getOrRefreshToken(userId: string, forceRefresh?: boolean)` - Get or refresh FCM token
- `registerForStatementNotifications(userId: string, token: string, statementId: string)` - Subscribe to notifications for a statement
- `unregisterFromStatementNotifications(statementId: string)` - Unsubscribe from statement notifications
- `requestPermission()` - Request notification permission from user
- `isSupported()` - Check if browser supports notifications
- `safeGetPermission()` - Safe permission check that handles iOS limitations
- `cleanup()` - Clean up on user logout
- `getDiagnostics()` - Get diagnostic information for troubleshooting

**Key Features:**
- Automatic token refresh every 30 days
- Token age tracking and validation
- iOS Safari compatibility handling
- Comprehensive error handling and logging

**Usage:**
```typescript
import { notificationService } from '@/services/notificationService';

// Initialize for a user
await notificationService.initialize(userId);

// Subscribe to notifications for a statement
const token = notificationService.getToken();
await notificationService.registerForStatementNotifications(userId, token, statementId);
```

#### 2. **Service Workers**

##### Firebase Messaging Service Worker (`/public/firebase-messaging-sw.js`)
Handles background push notifications when the app is not in focus.

**Key Features:**
- Multi-domain support (production, test, localhost)
- Badge count management with IndexedDB persistence
- Background message handling
- Notification click handling with deep linking
- Push event debugging and monitoring
- Experimental badge API support
- Notification cache for click event data
- Sound notification support (via message passing)

##### PWA Service Worker (`/src/sw.js`)
Handles PWA functionality and offline support (generated by Vite PWA plugin).

#### 3. **PWAWrapper Component** (`/src/view/components/pwa/PWAWrapper.tsx`)
React component that manages service worker registration and PWA features.

**Key Features:**
- Registers both PWA and Firebase service workers
- Handles PWA update prompts
- Manages notification permission prompts
- Clears badge count when app is focused

#### 4. **Firebase Configuration**
- **Config:** `/src/controllers/db/config.ts` - Firebase app initialization
- **VAPID Key:** `/src/controllers/db/configKey.ts` - Contains VAPID key for FCM

### Database Collections

#### Firestore Collections:
1. **`askedToBeNotified`** - Stores FCM tokens for users subscribed to statement notifications
   ```typescript
   {
     userId: string,
     statementId: string,
     token: string,
     lastUpdate: Date,
     subscribed: boolean
   }
   ```
   - Document ID format: `${token}_${statementId}`

2. **`pushNotifications`** - Stores FCM token metadata and device information
   ```typescript
   {
     token: string,
     userId: string,
     lastUpdate: Date | Timestamp,
     lastRefresh: Date | Timestamp,
     platform: string, // 'web'
     deviceInfo: {
       userAgent: string,
       language: string
     }
   }
   ```
   - Document ID: FCM token
   - Used for token lifecycle management

3. **`statementsSubscribe`** - Stores user subscriptions to statements
   ```typescript
   {
     user: {
       uid: string,
       displayName: string,
       photoURL: string
     },
     statementId: string,
     getInAppNotification: boolean,
     role: string
   }
   ```

4. **`inAppNotifications`** - Stores in-app notifications for users
   ```typescript
   {
     userId: string,
     parentId: string,
     parentStatement: string,
     statementType: string,
     questionType: string,
     text: string,
     creatorId: string,
     creatorName: string,
     creatorImage: string,
     createdAt: Date,
     read: boolean,
     notificationId: string,
     statementId: string
   }
   ```

### Firebase Functions

**`updateInAppNotifications`** (`/functions/src/fn_notifications.ts`)
- Triggered when a new statement is created
- Sends push notifications to all subscribed users who have `getPushNotification: true`
- Creates in-app notifications for subscribed users who have `getInAppNotification: true`
- Includes support for nested reply notifications (notifies top-level subscribers)

**Updated Notification Flow:**
1. Fetches subscribers from `statementsSubscribe` collection
2. Filters subscribers based on notification preferences:
   - In-app notifications: `getInAppNotification === true`
   - Push notifications: `getPushNotification === true && tokens.length > 0`
3. Extracts all tokens from subscribers' `tokens` arrays
4. Sends notifications to all registered devices

**Key Features:**
- Uses tokens from `statementsSubscribe` collection instead of `askedToBeNotified`
- Respects user's notification preferences per statement
- Token validation with dry-run testing
- Automatic removal of invalid tokens
- Batch sending with 500 message limit
- Exponential backoff retry logic (1s, 2s, 4s)
- Rate limiting protection (50ms delay between messages)
- Comprehensive error handling for different FCM error codes
- Development mode token validation skipping

**Notification Payload Structure:**
```typescript
{
  token: string,
  notification: {
    title: `New reply from ${creatorName}`,
    body: string // Truncated to 100 chars
  },
  data: {
    statementId: string,
    parentId: string,
    createdAt: string,
    notificationType: 'statement_reply'
  }
}

## Debugging Utilities

All debugging utilities are automatically loaded in development/testing mode.

### 1. **comprehensiveNotificationDebug()** (`/src/utils/notificationDebugger.ts`)
Comprehensive notification debugging tool with detailed diagnostics.

**Usage:**
```javascript
comprehensiveNotificationDebug()
// or in console:
window.comprehensiveNotificationDebug()
```

**Features:**
- Environment configuration check
- Firebase configuration validation
- Browser capability detection
- Service worker registration status
- Authentication status
- FCM token validation
- Common issue detection
- Detailed recommendations

### 2. **debugNotifications()** (`/src/utils/debugNotifications.ts`)
General notification debugging tool.

**Usage:**
```javascript
debugNotifications()
```

**Features:**
- Check browser notification support
- Verify permission status
- Test FCM token generation
- Check service worker registration
- Display current subscriptions

### 3. **fixChromeServiceWorker()** (`/src/utils/fixChromeServiceWorker.ts`)
Fixes Chrome-specific issue where Firebase service worker gets unregistered.

**Usage:**
```javascript
fixChromeServiceWorker()
```

**When to use:**
- Chrome not receiving notifications
- Firebase service worker missing
- After clearing browser data

### 4. **monitorNotifications()** (`/src/utils/monitorNotifications.ts`)
Real-time notification monitoring.

**Usage:**
```javascript
monitorNotifications()
```

**Features:**
- Monitor incoming FCM messages
- Track foreground message handling
- Display notification payloads in real-time

### 5. **debugServiceWorkerScopes()** (`/src/utils/debugServiceWorkerScopes.ts`)
Check service worker registrations and scope conflicts.

**Usage:**
```javascript
debugServiceWorkerScopes()
```

**Output:**
- List all registered service workers
- Identify scope conflicts
- Check for missing Firebase SW

### 6. **testNotification()** (`/src/utils/testNotification.ts`)
Send a test notification to yourself.

**Usage:**
```javascript
testNotification()
```

### 7. **debugGroupNotifications()** (`/src/utils/debugGroupNotifications.ts`)
Debug notification subscriptions for a specific statement/group.

**Usage:**
```javascript
debugGroupNotifications('statementId')
```

**Features:**
- List all users subscribed to a statement
- Check their notification settings
- Verify FCM tokens

### 8. **compareBrowserTokens()** (`/src/utils/compareBrowserTokens.ts`)
Compare FCM tokens across different browser sessions.

**Usage:**
```javascript
compareBrowserTokens()
```

### 9. **notificationStatus()** (`/src/utils/notificationStatus.ts`)
Display current notification system status.

**Usage:**
```javascript
notificationStatus()
```

### 10. **monitorPushEvents()** (`/src/utils/monitorPushEvents.ts`)
Monitor push events at the service worker level.

**Usage:**
```javascript
monitorPushEvents()
```

**Features:**
- Intercept push events
- Monitor SW messages
- Track notification creation

## Common Issues and Solutions

### Issue: Chrome Not Receiving Notifications

**Symptoms:**
- Firefox receives notifications but Chrome doesn't
- Token generated successfully but no messages received

**Solution:**
1. Run `debugServiceWorkerScopes()` to check SW registration
2. Run `fixChromeServiceWorker()` to fix registration
3. Refresh page and test again

**Root Cause:** Chrome aggressively unregisters service workers with overlapping scopes.

### Issue: "No Push Subscription Found"

**Solution:**
1. Check browser notification permissions
2. Run `debugNotifications()` to diagnose
3. Clear browser data and re-register

### Issue: Notifications Work Locally but Not in Production

**Check:**
1. VAPID key matches between client and server
2. Firebase project configuration is correct
3. Service worker is properly deployed
4. Run `debugDeploymentNotifications()` to check config

## Testing Notifications

### Manual Testing:
1. Open app in two different browsers (e.g., Chrome and Firefox)
2. Login with different users
3. Join the same group/statement
4. Post a message from one browser
5. Other browser should receive notification

### Using Debug Tools:
1. Run `monitorNotifications()` in receiving browser
2. Run `testNotification()` in sending browser
3. Watch console for push event logs

## Best Practices

1. **Token Management:**
   - Tokens automatically refresh every 30 days
   - Service tracks token age and last refresh time
   - Invalid tokens are automatically cleaned up
   - Store tokens in Firestore for persistence

2. **Permission Handling:**
   - Request permission at appropriate time
   - Handle permission denial gracefully
   - Use `safeGetPermission()` for iOS compatibility
   - Provide clear explanation why notifications are needed

3. **Service Worker Management:**
   - Both PWA and Firebase SWs must be registered
   - Service worker readiness is checked before token generation
   - Handle SW updates properly
   - Monitor for SW conflicts

4. **Error Handling:**
   - Log errors to console.error (not console.log)
   - Handle offline scenarios
   - Validate tokens before sending
   - Implement retry logic with exponential backoff

## Environment Variables

The app automatically selects Firebase configuration based on domain:
- **Production:** `freedi.tech`, `delib.web.app`
- **Test:** `freedi-test.web.app`
- **Development:** `localhost`, `127.0.0.1`

## Security Considerations

1. **VAPID Keys:** Never commit VAPID private keys
2. **Token Storage:** FCM tokens are stored securely in Firestore
3. **Permissions:** Users can only subscribe to statements they have access to
4. **Token Validation:** Invalid tokens are automatically removed

## Troubleshooting Checklist

- [ ] Browser supports notifications (`'Notification' in window`)
- [ ] Service workers supported (`'serviceWorker' in navigator`)
- [ ] Notification permission granted
- [ ] Firebase SW registered (`/firebase-messaging-sw.js`)
- [ ] FCM token generated successfully
- [ ] Token stored in Firestore
- [ ] User subscribed to statement notifications
- [ ] Firebase Function has correct VAPID key
- [ ] No scope conflicts between service workers
- [ ] Browser not blocking notifications

## React Integration

### useNotifications Hook (`/src/controllers/hooks/useNotifications.ts`)
React hook for managing notifications in components.

**Features:**
- Automatic initialization based on auth state
- Permission state management
- Service worker message handling
- Test notification sending
- Notification clearing

**Usage:**
```typescript
import { useNotifications } from '@/controllers/hooks/useNotifications';

function MyComponent() {
  const { 
    permissionState, 
    requestPermission, 
    sendTestNotification,
    clearNotifications 
  } = useNotifications();
  
  // Check permission state
  if (permissionState.permission === 'default') {
    // Show permission request UI
  }
}
```

### NotificationPreferences Component (`/src/view/components/notifications/NotificationPreferences.tsx`)
Comprehensive UI component for managing all notification settings for a statement.

**Features:**
- Toggle in-app notifications
- Toggle push notifications (across all devices)
- Toggle email notifications
- Real-time preference updates
- Loading and saving states

**Usage:**
```typescript
import NotificationPreferences from '@/view/components/notifications/NotificationPreferences';

<NotificationPreferences statementId={statementId} />
```

### NotificationSubscriptionButton Component
Quick toggle button for push notifications with permission handling.

### NotificationDiagnostics Component
UI component for displaying notification system status and debugging.

## Notification Flow Diagram

```
1. User grants permission
   └─> NotificationService.requestPermission()
   
2. FCM token generated
   └─> NotificationService.getOrRefreshToken()
       ├─> Token stored in Firestore (pushNotifications collection)
       └─> Token synced to all user's subscriptions (tokens array)
   
3. User subscribes to statement / Updates preferences
   └─> updateNotificationPreferences() or NotificationService.registerForStatementNotifications()
       ├─> Preferences updated in statementsSubscribe collection
       ├─> Token added to subscription's tokens array
       └─> Legacy: Also stored in askedToBeNotified collection
   
4. New statement created
   └─> Firebase Function triggered (updateInAppNotifications)
       ├─> Fetch subscribers from statementsSubscribe
       ├─> Filter by notification preferences
       │   ├─> getInAppNotification: true → Create in-app notifications
       │   └─> getPushNotification: true → Extract tokens for push
       └─> Send FCM messages to all tokens
   
5. Push notification received
   ├─> App in foreground: onMessage handler
   └─> App in background: Service Worker handles
       └─> Shows notification with badge
   
6. User clicks notification
   └─> Service Worker opens/focuses app
       └─> Deep links to relevant content

7. Multi-device management
   ├─> Login on new device: Token added to all subscriptions
   ├─> Logout: Token removed from all subscriptions
   └─> Preference change: Affects all devices immediately
```

## Performance Considerations

1. **Token Validation:**
   - Dry-run validation can be skipped in development
   - Batch validation for multiple tokens
   - Cache validation results temporarily

2. **Message Sending:**
   - Batch size limited to 500 messages
   - 50ms delay between individual sends
   - Exponential backoff for retries

3. **Database Operations:**
   - Batch writes for in-app notifications
   - Parallel fetching of notification data
   - Efficient token cleanup

## iOS/Safari Considerations

- iOS Safari has limited PWA support
- Push notifications require iOS 16.4+
- Service workers have restrictions
- Use `safeGetPermission()` for compatibility
- Badge API may not be supported

## Migration Notes

### Moving from askedToBeNotified to statementsSubscribe

The notification system has been updated to use the `statementsSubscribe` collection as the primary source for notification preferences and tokens. The `askedToBeNotified` collection is maintained for backward compatibility but should be considered deprecated.

**Key Changes:**
1. FCM tokens are now stored in the `tokens` array within each subscription document
2. Notification preferences are controlled by boolean flags in the subscription
3. All devices for a user can be managed from a single subscription document

**Migration Path:**
- Existing `askedToBeNotified` entries continue to work
- New registrations update both collections for compatibility
- Future updates should phase out `askedToBeNotified` collection

## Additional Resources

- [Firebase Cloud Messaging Docs](https://firebase.google.com/docs/cloud-messaging/js/client)
- [Web Push Protocol](https://developers.google.com/web/fundamentals/push-notifications)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [Notification API](https://developer.mozilla.org/en-US/docs/Web/API/Notifications_API)
- [Badging API](https://developer.mozilla.org/en-US/docs/Web/API/Badging_API)