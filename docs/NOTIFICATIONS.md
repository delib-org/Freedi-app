# Notifications Documentation

## Overview

The Freedi app uses Firebase Cloud Messaging (FCM) for push notifications. This document covers the notification system architecture, key components, and debugging utilities.

## Architecture

### Core Components

#### 1. **NotificationService** (`/src/services/notificationService.ts`)
The main service that handles all notification-related operations.

**Key Methods:**
- `initialize(userId: string)` - Initialize notifications for a user
- `getOrRefreshToken(forceRefresh?: boolean)` - Get or refresh FCM token
- `subscribeToStatementNotifications(statementId: string)` - Subscribe to notifications for a statement
- `unsubscribeFromStatementNotifications(statementId: string)` - Unsubscribe from statement notifications
- `requestPermission()` - Request notification permission from user
- `isSupported()` - Check if browser supports notifications
- `clearToken()` - Clear FCM token and unregister

**Usage:**
```typescript
import { notificationService } from '@/services/notificationService';

// Initialize for a user
await notificationService.initialize(userId);

// Subscribe to notifications for a statement
await notificationService.subscribeToStatementNotifications(statementId);
```

#### 2. **Service Workers**

##### Firebase Messaging Service Worker (`/public/firebase-messaging-sw.js`)
Handles background push notifications when the app is not in focus.

**Key Features:**
- Multi-domain support (production, test, localhost)
- Badge count management
- Background message handling
- Notification click handling

##### PWA Service Worker (`/src/sw.js`)
Handles PWA functionality and offline support (generated by Vite PWA plugin).

#### 3. **PWAWrapper Component** (`/src/view/components/pwa/PWAWrapper.tsx`)
React component that manages service worker registration and PWA features.

**Key Features:**
- Registers both PWA and Firebase service workers
- Handles PWA update prompts
- Manages notification permission prompts
- Clears badge count when app is focused

#### 4. **Firebase Configuration**
- **Config:** `/src/controllers/db/config.ts` - Firebase app initialization
- **VAPID Key:** `/src/controllers/db/configKey.ts` - Contains VAPID key for FCM

### Database Collections

#### Firestore Collections:
1. **`askedToBeNotified`** - Stores FCM tokens for users subscribed to statement notifications
   ```typescript
   {
     userId: string,
     statementId: string,
     token: string,
     createdAt: timestamp
   }
   ```

2. **`pushNotifications`** - Stores user push notification settings
   ```typescript
   {
     uid: string,
     token: string,
     timestamp: timestamp,
     browser?: string
   }
   ```

3. **`statementsSubscribe`** - Stores user subscriptions to statements
   ```typescript
   {
     userId: string,
     statementId: string,
     getInAppNotification: boolean,
     role: string
   }
   ```

### Firebase Functions

**`updateInAppNotifications`** (`/functions/src/fn_notifications.ts`)
- Triggered when a new statement is created
- Sends push notifications to all subscribed users
- Validates tokens and removes invalid ones
- Handles batch sending with retry logic

## Debugging Utilities

All debugging utilities are automatically loaded in development/testing mode.

### 1. **debugNotifications()** (`/src/utils/debugNotifications.ts`)
Comprehensive notification debugging tool.

**Usage:**
```javascript
debugNotifications()
```

**Features:**
- Check browser notification support
- Verify permission status
- Test FCM token generation
- Check service worker registration
- Display current subscriptions

### 2. **fixChromeServiceWorker()** (`/src/utils/fixChromeServiceWorker.ts`)
Fixes Chrome-specific issue where Firebase service worker gets unregistered.

**Usage:**
```javascript
fixChromeServiceWorker()
```

**When to use:**
- Chrome not receiving notifications
- Firebase service worker missing
- After clearing browser data

### 3. **monitorNotifications()** (`/src/utils/monitorNotifications.ts`)
Real-time notification monitoring.

**Usage:**
```javascript
monitorNotifications()
```

**Features:**
- Monitor incoming FCM messages
- Track foreground message handling
- Display notification payloads in real-time

### 4. **debugServiceWorkerScopes()** (`/src/utils/debugServiceWorkerScopes.ts`)
Check service worker registrations and scope conflicts.

**Usage:**
```javascript
debugServiceWorkerScopes()
```

**Output:**
- List all registered service workers
- Identify scope conflicts
- Check for missing Firebase SW

### 5. **testNotification()** (`/src/utils/testNotification.ts`)
Send a test notification to yourself.

**Usage:**
```javascript
testNotification()
```

### 6. **debugGroupNotifications()** (`/src/utils/debugGroupNotifications.ts`)
Debug notification subscriptions for a specific statement/group.

**Usage:**
```javascript
debugGroupNotifications('statementId')
```

**Features:**
- List all users subscribed to a statement
- Check their notification settings
- Verify FCM tokens

### 7. **compareBrowserTokens()** (`/src/utils/compareBrowserTokens.ts`)
Compare FCM tokens across different browser sessions.

**Usage:**
```javascript
compareBrowserTokens()
```

### 8. **notificationStatus()** (`/src/utils/notificationStatus.ts`)
Display current notification system status.

**Usage:**
```javascript
notificationStatus()
```

### 9. **monitorPushEvents()** (`/src/utils/monitorPushEvents.ts`)
Monitor push events at the service worker level.

**Usage:**
```javascript
monitorPushEvents()
```

**Features:**
- Intercept push events
- Monitor SW messages
- Track notification creation

## Common Issues and Solutions

### Issue: Chrome Not Receiving Notifications

**Symptoms:**
- Firefox receives notifications but Chrome doesn't
- Token generated successfully but no messages received

**Solution:**
1. Run `debugServiceWorkerScopes()` to check SW registration
2. Run `fixChromeServiceWorker()` to fix registration
3. Refresh page and test again

**Root Cause:** Chrome aggressively unregisters service workers with overlapping scopes.

### Issue: "No Push Subscription Found"

**Solution:**
1. Check browser notification permissions
2. Run `debugNotifications()` to diagnose
3. Clear browser data and re-register

### Issue: Notifications Work Locally but Not in Production

**Check:**
1. VAPID key matches between client and server
2. Firebase project configuration is correct
3. Service worker is properly deployed
4. Run `debugDeploymentNotifications()` to check config

## Testing Notifications

### Manual Testing:
1. Open app in two different browsers (e.g., Chrome and Firefox)
2. Login with different users
3. Join the same group/statement
4. Post a message from one browser
5. Other browser should receive notification

### Using Debug Tools:
1. Run `monitorNotifications()` in receiving browser
2. Run `testNotification()` in sending browser
3. Watch console for push event logs

## Best Practices

1. **Token Management:**
   - Tokens expire after 30 days
   - Service automatically refreshes tokens
   - Store tokens in Firestore for persistence

2. **Permission Handling:**
   - Request permission at appropriate time
   - Handle permission denial gracefully
   - Provide clear explanation why notifications are needed

3. **Service Worker Management:**
   - Both PWA and Firebase SWs must be registered
   - Handle SW updates properly
   - Monitor for SW conflicts

4. **Error Handling:**
   - Log errors to console.error (not console.log)
   - Handle offline scenarios
   - Validate tokens before sending

## Environment Variables

The app automatically selects Firebase configuration based on domain:
- **Production:** `freedi.tech`, `delib.web.app`
- **Test:** `freedi-test.web.app`
- **Development:** `localhost`, `127.0.0.1`

## Security Considerations

1. **VAPID Keys:** Never commit VAPID private keys
2. **Token Storage:** FCM tokens are stored securely in Firestore
3. **Permissions:** Users can only subscribe to statements they have access to
4. **Token Validation:** Invalid tokens are automatically removed

## Troubleshooting Checklist

- [ ] Browser supports notifications (`'Notification' in window`)
- [ ] Service workers supported (`'serviceWorker' in navigator`)
- [ ] Notification permission granted
- [ ] Firebase SW registered (`/firebase-messaging-sw.js`)
- [ ] FCM token generated successfully
- [ ] Token stored in Firestore
- [ ] User subscribed to statement notifications
- [ ] Firebase Function has correct VAPID key
- [ ] No scope conflicts between service workers
- [ ] Browser not blocking notifications

## Additional Resources

- [Firebase Cloud Messaging Docs](https://firebase.google.com/docs/cloud-messaging/js/client)
- [Web Push Protocol](https://developers.google.com/web/fundamentals/push-notifications)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)